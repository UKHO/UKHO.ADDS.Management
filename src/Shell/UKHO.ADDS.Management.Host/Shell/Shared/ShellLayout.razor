@using System.Globalization
@using UKHO.ADDS.Management.Shell.Components
@using UKHO.ADDS.Management.Shell.Models
@using UKHO.ADDS.Management.Shell.Modules
@using UKHO.ADDS.Management.Shell.Services
@using UKHO.ADDS.Management.Shell.Services.Storage
@inherits LayoutComponentBase

@inject ModulePageService DashboardPageService
@inject DeploymentsJsonLoader DeploymentsLoader
@inject ILogger<ShellLayout> Logger
@inject NavigationManager NavManager
@inject DeploymentSelectionStorage SelectionStorage
@inject IJSRuntime JS

<RadzenComponents />

<RadzenLayout Style="grid-template-columns: auto 1fr auto; grid-template-areas: 'rz-header rz-header rz-header' 'rz-sidebar rz-body rz-config-sidebar'">
    <RadzenHeader>
        <ChildContent>
            <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0px">
                <RadzenColumn Size="5">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                        <RadzenSidebarToggle Click="@(() => _sidebarExpanded = !_sidebarExpanded)" />
                        <span style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">UKHO ADDS Mock Dashboard</span>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="7">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                        <div class="align-items-center" style="display: inline-flex; gap: 0.5rem;">
                            <DeploymentSelector Deployments="_deployments"
                                                SelectedDeploymentId="_selectedDeploymentId"
                                                SelectedDeploymentIdChanged="OnSelectedDeploymentIdChanged" />

                            <RadzenButton Text="Logout"
                                          Class="rz-text-nowrap rz-mx-2 rz-mx-lg-4"
                                          Click="@OnLogoutClicked" />
                        </div>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </ChildContent>
    </RadzenHeader>

    <RadzenBody @ref="_body0" style="background-color: #15171C;">
        <ChildContent>
            <RadzenContentContainer Name="main" style="width: 100%; height: 100%; border: none; margin: 0; padding: 0; overflow: hidden;">
                @Body
            </RadzenContentContainer>
        </ChildContent>
    </RadzenBody>

    <RadzenSidebar @ref="_sidebar0" @bind-Expanded="@_sidebarExpanded" class="demos-sidebar" style="display: flex; flex-direction: column">
        <div style="flex: 1; overflow: auto">
            <RadzenPanelMenu Match="NavLinkMatch.Prefix">
                @foreach (var category in _pages)
                {
                    <NavigationItem @key=category @bind-Expanded=@category.Expanded Example=@category>
                        @if (category.Children != null)
                        {
                            @foreach (var example in category.Children)
                            {
                                if (example.Children != null)
                                {
                                    <NavigationItem @key=example @bind-Expanded=@example.Expanded Example=@example>
                                        @foreach (var child in example.Children)
                                        {
                                            <NavigationItem @key=child @bind-Expanded=@child.Expanded Example=@child />
                                        }
                                    </NavigationItem>
                                }
                                else
                                {
                                    <NavigationItem @key=example @bind-Expanded=@example.Expanded Example=@example />
                                }
                            }
                        }
                    </NavigationItem>
                }
            </RadzenPanelMenu>
        </div>
    </RadzenSidebar>
</RadzenLayout>

@if (!_rendered)
{
    <div class="rz-app-loading">
        <div class="logo-loading"></div>
    </div>
}

@code {
    private const string ModuleId = "Samples";
    private const string ModuleAssemblyName = "UKHO.ADDS.Management.Modules.Samples";

    private RadzenSidebar _sidebar0;
    private RadzenBody _body0;
    private bool _sidebarExpanded = true;
    private bool _rendered;
    private IEnumerable<ModulePage> _pages;
    private ModulePage _page;

    private IEnumerable<DeploymentRef> _deployments = Enumerable.Empty<DeploymentRef>();
    private string _selectedDeploymentId = string.Empty;
    private bool _deploymentSelectionInitialized;

    protected override void OnInitialized()
    {
        _pages = DashboardPageService.Pages;

        NavManager.LocationChanged += OnLocationChanged;
        _page = DashboardPageService.FindCurrent(new Uri(NavManager.Uri));

        Thread.CurrentThread.CurrentCulture = new CultureInfo("en-GB");
    }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("ShellLayout: loading deployments for header selector from host deployments.json");
        var result = await DeploymentsLoader.LoadForModuleAsync(ModuleAssemblyName);
        if (result.HasError)
        {
            Logger.LogWarning("ShellLayout: deployments load error: {Error}", result.ErrorMessage);
            _deployments = Enumerable.Empty<DeploymentRef>();
            _selectedDeploymentId = string.Empty;
            return;
        }

        _deployments = result.Items;
        if (!_deployments.Any())
        {
            Logger.LogWarning("ShellLayout: deployments loaded but list was empty");
            _selectedDeploymentId = string.Empty;
            return;
        }

        var firstValid = _deployments.FirstOrDefault(d => !string.IsNullOrWhiteSpace(d.Id));
        if (firstValid is null)
        {
            Logger.LogWarning("ShellLayout: deployments loaded ({Count}) but none had a valid 'id'", _deployments.Count());
            _selectedDeploymentId = string.Empty;
            return;
        }

        _selectedDeploymentId = firstValid.Id;
        Logger.LogInformation(
            "ShellLayout: deployments loaded ({Count}); defaulting selection to '{Selected}'",
            _deployments.Count(),
            _selectedDeploymentId);
    }

    private async Task OnSelectedDeploymentIdChanged(string deploymentId)
    {
        _selectedDeploymentId = deploymentId;
        await SelectionStorage.SetAsync(ModuleId, _selectedDeploymentId);
    }

    private void OnLocationChanged(object sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs args)
    {
        var currentExample = DashboardPageService.FindCurrent(new Uri(args.Location));
        if (currentExample != _page)
        {
            _page = currentExample;
            StateHasChanged();
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _rendered = true;
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _deploymentSelectionInitialized || !_deployments.Any())
        {
            return;
        }

        _deploymentSelectionInitialized = true;

        await JS.InvokeVoidAsync(
            "console.debug",
            $"ShellLayout: deployments available={_deployments.Count()}, defaultSelected='{_selectedDeploymentId}'");

        var stored = await SelectionStorage.GetAsync(ModuleId);
        await JS.InvokeVoidAsync(
            "console.debug",
            $"ShellLayout: stored selection for module '{ModuleId}' is '{stored}'");

        var selected = !string.IsNullOrWhiteSpace(stored) && _deployments.Any(d => d.Id == stored)
            ? stored!
            : _deployments.First(d => !string.IsNullOrWhiteSpace(d.Id)).Id;

        if (!string.Equals(_selectedDeploymentId, selected, StringComparison.Ordinal))
        {
            _selectedDeploymentId = selected;
            await JS.InvokeVoidAsync(
                "console.debug",
                $"ShellLayout: applying stored selection '{_selectedDeploymentId}'");
            StateHasChanged();
        }

        await SelectionStorage.SetAsync(ModuleId, _selectedDeploymentId);
        await JS.InvokeVoidAsync(
            "console.debug",
            $"ShellLayout: persisted selection '{_selectedDeploymentId}' for module '{ModuleId}'");
    }

    private void OnLogoutClicked()
    {
        // Full-page redirect so the middleware can issue the SignOutResult → 302 to Keycloak
        NavManager.NavigateTo("/authentication/logout", forceLoad: true);
    }
}
