@page "/sample/main"
@using UKHO.ADDS.Management.Shell.Models
@using UKHO.ADDS.Management.Shell.Services
@using UKHO.ADDS.Management.Shell.Configuration
@using UKHO.ADDS.Management.Modules.Samples.Configuration
@using UKHO.ADDS.Management.Shell.Components
@using UKHO.ADDS.Management.Shell.Services.Storage
@using UKHO.ADDS.Management.Modules.Samples.Pages
@inject IModuleConfigurationProvider ConfigurationProvider
@inject DeploymentSelectionStorage SelectionStorage

<h3>@displayName</h3>

@if (!string.IsNullOrWhiteSpace(loadError))
{
    <ConfigBlockingError Message="loadError" />
}
else
{
    <ConfigWarning Message="selectionWarning" />

    @if (!string.IsNullOrWhiteSpace(configError))
    {
        <ConfigBlockingError Message="configError" />
    }

    <div>
        <p>BaseUrl: @baseUrl</p>
        <p>TimeoutSeconds: @timeoutSeconds</p>
    </div>
}

@code {
    private string selectedId = string.Empty;
    private string displayName = "Sample Module";
    private string baseUrl = string.Empty;
    private int timeoutSeconds = 0;
    private const string moduleId = "Samples";
    private string loadError = string.Empty;
    private string configError = string.Empty;
    private string selectionWarning = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var stored = await SelectionStorage.GetAsync(moduleId);
        if (!string.IsNullOrWhiteSpace(stored))
        {
            selectedId = stored!;
        }
        else
        {
            loadError = "No deployment selected. Please select a deployment from the header.";
            return;
        }

        await BindOptions();
    }

    private Task BindOptions()
    {
        var (options, errorMessage) = SamplePageState.BindOptions(ConfigurationProvider, selectedId, moduleId);
        configError = errorMessage ?? string.Empty;

        displayName = options.DisplayName ?? "Sample Module";
        baseUrl = options.BaseUrl ?? string.Empty;
        timeoutSeconds = options.TimeoutSeconds;
        return Task.CompletedTask;
    }
}
